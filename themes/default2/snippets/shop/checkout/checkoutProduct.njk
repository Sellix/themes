{% set id = uid() %}
{% set shop = global.common.shopInfo.shop %}
{% set isInvoice = global.request.type == 'invoice' %}
{% set colors = themeProperties.current_colors %}

{% set properties = args.properties %}
{% set invoice = args.invoice %}
{% set product = args.product %}
{% set quantity = args.quantity %}
{% set image = cdn_link(product.cloudflare_image_id, 'shopItem') %}

{% set isPlaceholder = not product.cloudflare_image_id %}

{% set descriptionEnabled = safe_get(properties.description_enabled, true) %}

{% set productBgColor = safe_get(properties.product_container_background_color, 'background_accent_dark') %}
{% set productShowBorder = safe_get(properties.product_container_show_border, true) %}
{% set productShadow = safe_get(properties.product_container_shadow, 'none') %}
{% set productBorderRadius = safe_get(properties.product_container_border_radius, 8) %}
{% set productPaddingVert = safe_get(properties.product_container_padding_vert, 16) %}
{% set productPaddingHoriz = safe_get(properties.product_container_padding_horiz, 16) %}
{% set titleFontColor = safe_get(properties.product_title_font_color, 'light_font_color') %}
{% set titleFontSize = safe_get(properties.product_title_font_size, 18) %}
{% set titleFontWeight = safe_get(properties.product_title_font_weight, 500) %}
{% set titleLineHeight =  safe_get(properties.product_title_line_height, 20) %}

{% set addonsProps = {} %}
{% set variantsProps = {} %}
{% for key, value in properties %}
  {% if key.slice(0, 6) === 'addons' %}
    {% set addonsProps = addonsProps | set_attribute(key | replace('addons_', ''), value) %}
  {% endif %}

  {% if key.slice(0, 8) === 'variants' %}
    {% set variantsProps = variantsProps | set_attribute(key | replace('variants_', ''), value) %}
  {% endif %}
{% endfor %}

{% set globalClass = ['snippet-checkout-product'] %}
{% set localClass = id %}

<style>
  .{{ localClass }} {
    background: {{ colors[productBgColor] }};
    border: {{ "1px solid var(--borderColor)" if productShowBorder else "none" }};
    box-shadow: {{ productShadow }};
    border-radius: {{ productBorderRadius }}px;
    padding: {{ productPaddingVert }}px {{ productPaddingHoriz }}px;
  }

  .{{ localClass }}__title-text {
    color: {{ colors[titleFontColor] }};
    font-size: {{ titleFontSize }}px;
    font-weight: {{ titleFontWeight }};
    line-height: {{ titleLineHeight }}px;
  }
  .{{ globalClass }}__description-container {
    display: flex;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--borderColor);
  }
  .{{ globalClass }}__description-right,
  .{{ globalClass }}__description-left {
    width: 50%;
  }
  .{{ globalClass }}__description-left {
    margin-right: 1rem;
  }
  .{{ globalClass }}__description-right > div,
  .{{ globalClass }}__description-left > div {
    padding-bottom: 1rem;
  }
  @media (max-width: 768px) {
    .{{ globalClass }}__description-container {
      flex-direction: column;
    }
    .{{ globalClass }}__description-right,
    .{{ globalClass }}__description-left {
      width: 100%;
    }
  }
</style>

<div class="{{ globalClass }} {{ localClass }}" data-checkout-product="{{ product.uniqid }}">
  <div class="{{ globalClass }}__details">
    <div class="{{ globalClass }}__image {{'placeholder' if isPlaceholder}}">
      {% if isPlaceholder %}
        <i class="fa-light fa-layer-group"></i>
      {% else %}
        <img src="{{image}}" alt="{{product.title}}" loading="lazy" />
      {% endif %}
    </div>

    <div class="{{ globalClass }}__title unselectable">
      <div class="{{ globalClass }}__title-text {{ localClass }}__title-text">
        <div>
          {{product.title}}
        </div>

        {% if isInvoice %}
          <div class="{{ globalClass }}__product-quantity total unselectable">
            {{ 'shop.checkout.stock' | t }}: {{product.quantity if product.quantity else product.unit_quantity}}
          </div>
        {% endif %}

        <div class="{{ globalClass }}__product-price">
          {% render_snippet 'Product: Price', product=product %}
        </div>
      </div>

      {% if descriptionEnabled %}
        <div class="{{ globalClass }}__chevron-icon">
          <span class="chevron d-none" data-checkout-product-toggle-description-button="1">
            {% render_snippet 'Icons: Chevron up' %}
          </span>

          <span class="chevron" data-checkout-product-toggle-description-button="1">
            {% render_snippet 'Icons: Chevron down' %}
          </span>
        </div>
      {% endif %}

      {% if not isInvoice and product.stock !== 0 %}
        <div class="{{ globalClass }}__product-count">
          {% render_snippet
            'Checkout: Product count',
            product=product,
            quantity=quantity,
            show_stock_info=false
          %}
        </div>

        <div
          class="{{ globalClass }}__remove-icon"
          data-product-id="{{product.uniqid}}"
          data-remove-button="1"
        >
          {% render_snippet 'Icons: Trash' %}
        </div>
      {% endif %}
    </div>
  </div>

  {% if descriptionEnabled %}
    <div
      class="{{ globalClass }}__description"
      style="height: 0; overflow: hidden"
      data-description-wrapper="1"
    >
      <div class="{{ globalClass }}__description-container">
        <div class="{{ globalClass }}__description-left">
          {% render_snippet
            'Product: Gallery',
            product=product,
            properties={'slider_height': 250, 'thumbnails_height': 125}
          %}
        </div>
        <div class="{{ globalClass }}__description-right">
          {% render_snippet
            'Product: Description',
            product=product,
            properties={'collapsable': true}
          %}
          {% render_snippet
            'Product: Warranty collapsable',
            product=product,
            properties={
              'body_padding_horiz': 0
            }
          %}
        </div>
      </div>
    </div>
  {% endif %}

  {% if (product.price_variants or []) | length and product.stock %}
    <div class="{{ globalClass }}__variants">
      {% render_snippet
        'Product: Variants',
        is_cart=true,
        product=product,
        properties=variantsProps,
        currency=shop.currency
      %}
    </div>
  {% endif %}

  {% if (product.addons or []) | length and product.stock %}
    <div class="{{ globalClass }}__addons">
      {% render_snippet
        'Product: Addons',
        product=product,
        invoice=invoice,
        properties=addonsProps,
        currency=shop.currency
      %}
    </div>
  {% endif %}
</div>

<script type='application/javascript'>
  $(document).ready(function () {
    const productId = '{{product.uniqid}}';

    new SellixCheckoutProductComponent(
      `.{{ localClass }}`,
      '{{shop.name}}',
      productId,
      {{renderOptions | dump | safe}},
    );

    $(document).on(`SellixCartUpdateEvent`, (e, eventInfo) => {
      const id = eventInfo && eventInfo.productId;
      const action = (eventInfo && eventInfo.action) || 'update';

      if (action === 'delete' && (!productId || id === productId)) {
        const addonsStore = new SellixProductAddonsStore('{{ shop.name }}');
        addonsStore.clear(productId);
      }
    });
  });
</script>
