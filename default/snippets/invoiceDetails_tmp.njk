{% set invoice = args.invoice %}

{% set lastCryptoTrn = invoice.crypto_transactions[invoice.crypto_transactions | length - 1] %}

{% set isCart = invoice.type === "SHOPPING_CART" %}
{% set isCashAppMode = (invoice.gateway === 'CASH_APP' and (invoice.status === 'PENDING' or invoice.status === 'PARTIAL' or invoice.status === 'WAITING_SHOP_ACTION')) %}
{% set isQrMode = invoice.crypto_uri and invoice.crypto_mode === 'QRCODE' %}
{% set isBinance = invoice.gateway === 'BINANCE' %}
{% set isBTCLN = invoice.gateway === 'BITCOIN_LN' %}

{% set state_gateway = 1 %}
{% set state_alert = true %}

<div class="shop-product-card" style="margin-top: 2.5rem">
  <div class="sellix-invoice-details">
    <div class="sellix-invoice-header">
      <div class="sellix-invoice-title {{'d-flex justify-content-between' if invoice.status === 'VOIDED' and invoice.void_details else '' }}">
        {% if insurance.status === 'WAITING_FOR_CONFIRMATIONS' and isQrMode %}
          <span style="margin-top: 1.25rem; text-align: center; width: 100%;">
            Awaiting Confirmation ({isCashAppMode ? null : ((invoice.crypto_transactions || []).slice(-1)[0] || {}).confirmations || '0' + "/" + (invoice.crypto_confirmations_needed || 0)})
            {% if not isCashAppMode %}
              {{ lastCryptoTrn.confirmations or '0' }}/{{ invoice.crypto_confirmations_needed or '0' }}
            {% endif %}
          </span>
        {% else %}
          {% if not (not state_gateway and gateway !== 0)
            or invoice.status !== 'CUSTOMER_DISPUTE_ONGOING'
            or invoice.status !== 'VOIDED'
            or invoice.status !== 'REVERSED'
            or invoice.status !== 'REFUNDED'
            or invoice.status !== 'WAITING_SHOP_ACTION'
          %}
            <span>{{'Processing' if invoice.status === 'PROCESSING' else 'Payment Details' }}</span>
          {% else %}
            {% if not state_gateway and state_gateway !== 0 %}
              Select payments method
            {% elif invoice.status === 'CUSTOMER_DISPUTE_ONGOING' %}
              Customer Dispute
            {% elif invoice.status === 'VOIDED' %}
              Invoice Voided
            {% elif invoice.status === 'PROCESSING' %}
              Processing
            {% elif invoice.status === 'REVERSED' %}
              Invoice Reversed
            {% elif invoice.status === 'REFUNDED' %}
              Invoice Refunded
            {% elif invoice.status === 'WAITING_SHOP_ACTION' and isCashAppMode %}
              Awaiting Shop Action
            {% else %}
            {% endif %}
          {% endif %}
        {% endif %}

        {% if invoice.status === 'VOIDED' and invoice.void_details === 'PRODUCT_SOLD_OUT' %}
          <span class="badge badge-cancelled ml-2">
            Product Sold Out
          </span>
        {% endif %}

        {% if invoice.status === 'VOIDED' and invoice.void_details === 'CART_PRODUCTS_SOLD_OUT' %}
          <span class="badge badge-cancelled ml-2">
            Cart Products Sold Out
          </span>
        {% endif %}
      </div>
    </div>

    {% if not state_gateway and state_gateway !== 0 %}
      {#
      <Gateway invoice={invoice} getInvoice={getInvoice} updateGateway={updateGateway} />
      #}
    {% endif %}

    {% if stat_gateway and (invoice.status === 'PENDING' or invoice.status === 'PARTIAL' or invoice.status === 'WAITING_FOR_CONFIRMATIONS') %}
      <div>
        {% if isCashAppMode %}
          {# <CashApp getInvoice={getInvoice} invoice={invoice} updateGateway={updateGateway} /> #}
        {% elif isBinance or isBTCLN or isQrMode %}
          {# <Qr isBinance={isBinance} invoice={invoice} updateGateway={updateGateway} /> #}
        {% else %}
          {#
            <Default
              invoice={invoice}
              updateGateway={updateGateway}
              manualSuccess={manualSuccess}
              setManualSuccess={() => setManualSuccess(true)}
            />
          #}
        {% endif %}
      </div>
    {% endif %}

    <div class="sellix-invoice-info">
      {% if invoice.status === 'PARTIAL' and state_alert %}
         <AlertPartial openModal={alert} closeModal={() => setAlert(false)} invoice={invoice} />
        PARTIAL
      {% elif invoice.status === 'CUSTOMER_DISPUTE_ONGOING' %}
        {# <AlertDispute /> #}
        CUSTOMER_DISPUTE_ONGOING
      {% elif invoice.status === 'VOIDED' %}
         {# <AlertCanceled /> #}
        VOIDED
      {% elif invoice.status === 'REVERSED' %}
         {# <AlertCanceled reversed /> #}
        REVERSED
      {% elif invoice.status === 'REFUNDED' %}
         {# <AlertCanceled refunded /> #}
        REFUNDED
      {% elif invoice.status === 'WAITING_FOR_CONFIRMATIONS' and isQrMode %}
         {# <AlertAwait invoice={invoice} /> #}
        WAITING_FOR_CONFIRMATIONS
      {% elif invoice.status === 'WAITING_SHOP_ACTION' and isCashAppMode %}
         {# <AlertAwait cashapp invoice={invoice} /> #}
        WAITING_SHOP_ACTION
      {% elif invoice.status === 'PROCESSING' %}
         {# <AlertProcessing invoice={invoice} /> #}
        PROCESSING
      {% endif %}
    </div>
  </div>

  {% render_snippet 'Invoice product details button', isCart=isCart %}
  {% if state_gateway %}
    {% render_snippet 'Invoice track button', invoiceId=invoice.uniqid %}
  {% endif %}
</div>
